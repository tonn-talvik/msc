\documentclass[a4paper,12pt]{article}
\usepackage[lmargin=30mm,rmargin=30mm,tmargin=25mm,bmargin=25mm,showframe]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{newtxtext} 

\usepackage{textcomp}
\usepackage{fdsymbol}
\usepackage{stmaryrd}
\usepackage{underscore}


\usepackage{newunicodechar}
\newunicodechar{Γ}{$\Gamma$}
\newunicodechar{ε}{$\epsilon$}
\newunicodechar{λ}{$\lambda$}
\newunicodechar{ρ}{$\rho$}
\newunicodechar{σ}{$\sigma$}
\newunicodechar{τ}{$\tau$}
\newunicodechar{∷}{$\Colon$} % requires fdsymbol
%\newunicodechar{∷}{$::$}
\newunicodechar{∏}{$\prod$}
%\newunicodechar{→}{$\rightarrow$} % not needed
\newunicodechar{⇒}{$\Rightarrow$}
\newunicodechar{⟹}{$\Longrightarrow$} % unused
%\newunicodechar{⊹}{$\hermitmatrix$} % requires stix
%\newunicodechar{⊹}{$+$}
\newunicodechar{⊹}{$\Diamond$}
\newunicodechar{⟦}{$\llbracket$}
\newunicodechar{⟧}{$\rrbracket$}
\newunicodechar{⟪}{$\langle\!\langle$}
\newunicodechar{⟫}{$\rangle\!\rangle$}
\newunicodechar{⟨}{$\langle$}
\newunicodechar{⟩}{$\rangle$}
%\newunicodechar{·}{$\cdot$} % not needed
\newunicodechar{⊔}{$\sqcup$}
\newunicodechar{⊓}{$\sqcap$}
\newunicodechar{∈}{$\in$}
%\newunicodechar{¬}{$\neg$} % not needed
\newunicodechar{≡}{$\equiv$}
\newunicodechar{≢}{$\neq$}
\newunicodechar{≤}{$\leq$}
\newunicodechar{≰}{$\nleq$}
\newunicodechar{⊑}{$\sqsubseteq$}
\newunicodechar{ℕ}{$\mathbb{N}$}

%\renewcommand{\ttdefault}{\sfdefault}
%\usepackage{inconsolata}

\usepackage[estonian]{babel}
%\usepackage[none]{hyphenat}


\usepackage{fancyhdr}
\fancypagestyle{FirstPage}{\fancyhf{}\renewcommand{\headrulewidth}{0pt}\fancyfoot[C]{Tallinn 2017}}

\addto\captionsestonian{
  \renewcommand*\contentsname{\vskip 60pt\centering Sisukord}
  \renewcommand*\listfigurename{\vskip 60pt\centering Jooniste loetelu}
}

%\usepackage{biblatex}
%\bibliography{thesis}

\usepackage{hyperref}


\usepackage[figure,table]{totalcount}

%\linespread{1.4}
%\renewcommand{\baselinestretch}{1.5}

\setlength{\parindent}{0pt}
\setlength{\parskip}{12pt}

\usepackage{titlesec}

% http://tex.stackexchange.com/questions/299969/titlesec-loss-of-section-numbering-with-the-new-update-2016-03-15
\usepackage{etoolbox}
\makeatletter
\patchcmd{\ttlh@hang}{\parindent\z@}{\parindent\z@\leavevmode}{}{}
\patchcmd{\ttlh@hang}{\noindent}{}{}{}
\makeatother

%\titleformat{\section}[block]{\color{blue}\Large\bfseries\filcenter}{}{1em}{}
\titlespacing*{\section}{0pt}{60pt}{18pt}
\titlespacing*{\subsection}{0pt}{24pt}{12pt}
% III tase: kiri 14pt, lõiguvahe enne ja pärast 12pt

\makeatletter
\patchcmd{\@verbatim}
  {\verbatim@font}
  {\verbatim@font\small}
  {}{}
\makeatother

\usepackage{float}
\floatstyle{boxed} 
\restylefloat{figure}

\usepackage{tikz}

\renewcommand{\labelitemi}{$\smblksquare$}

\usepackage{setspace}

\begin{document}
\onehalfspacing

\begin{verbatim}
λ ⟦ ⟧ ⟪ ⟫ ⟨ ⟩ · ⊹ ∷ ⊔ ⊓ Γ ρ ε σ τ ∈ ¬ ≡ ≢ ≤ ≰ ⊑ ∏ → ⇒ ⟹ _ ℕ 
\end{verbatim}
% ------------------------------------------------------------
  \begin{center}
    \textsc{tallinna tehnikaülikool}\\
    Infotehnoloogia teaduskond\\
    Arvutiteaduse instituut\\
    \vfill
    
    Tõnn Talvik 132619IAPM
    \vskip 3em 
    \LARGE\textsc{efekti analüüside ja nendel põhinevate programmiteisenduste sertifitseerimine}\\
    \normalsize\vskip 4em 
    Magistritöö\\
    \vskip 4em    
  \end{center}
  
  \begin{flushright}
    \begin{tabular}{ r l }
      Juhendaja:& Tarmo Uustalu\\
      & Professor \\
    \end{tabular}
    \vfill
  \end{flushright}
  
  \thispagestyle{FirstPage}
  \clearpage
  \setcounter{page}{2}
% ------------------------------------------------------------

\section*{\vskip 60pt\centering Autorideklaratsioon}

Kinnitan, et olen koostanud antud lõputöö iseseisvalt ning seda ei ole kellegi teise poolt varem kaitsmisele esitatud. Kõik töö koostamisel kasutatud teiste autorite tööd, olulised seisukohad, kirjandusallikatest ja mujalt pärinevad andmed on töös viidatud.

Autor: Tõnn Talvik

8. mai 2017
\clearpage

\section*{\vskip 60pt\centering Annotatsioon}
[tekst]
         
Lõputöö on kirjutatud eesti keeles ning sisaldab teksti [lehekülgede arv töö põhiosas] leheküljel, [peatükkide arv] peatükki, \totalfigures\ joonist, [tabelite arv] tabelit.
\clearpage

\section*{\vskip 60pt\centering Abstract\\
Certification of effect analysis and program transformations based on the analysis}
[text]
The thesis is in Estonian and contains [pages] pages of text, [chapters] chapters, \totalfigures\ figures, [tables] tables.
\clearpage

\tableofcontents
\clearpage

\listoffigures
\clearpage







\section{Sissejuhatus}

% background and motivation?
Taust: efektid ja monaadid. Moggi, Benton, Katsumata.

% https://courses.cs.ttu.ee/pages/Problem_Statement

Töö eesmärgiks on realiseerida sõltuvate tüüpidega programmeerimiskeeles Agda idee tõestus taseme
raamistu efektide analüüsiks ja nendele põhinevateks programmiteisendusteks.
Samas raamistus peab saama näidata, et need analüüsid ja teisendused on korrektsed.
% Sissejuhatuses tutvustab autor töö teemat, töö eesmärke, lahendatavat probleemistikku,
% andes samuti ülevaate töö ülesehitusest. Sissejuhatuses kirjeldatakse ka töö
% lähtetingimused, alamülesanded ja vajadusel ka täiendavad nõuded (vt jaotist 2.4 ).

% Lõputöös peab sisalduma selge lõpetaja poolt lahendatava ülesande püstitus.

% Magistritöös esitatakse lahendatava ülesande püstitus töö sissejuhatuses, kattes järgmised punktid:
% - töös lahendatavad küsimused ja lähtetingimused,
% - eritingimused, mida on rakendatud ülesande lahendamisel/ülesande püstitamisel.

% Rigor
rääkida Agdast ja tõestustest

% Reproducibility
Töö käigus valminud lähtekood on tulemuste reprodutseerimiseks allalaetav aadressilt \url{https://github.com/tonn-talvik/msc}.
Lähtekoodi kompileerimiseks on kasutatud Agda versiooni 2.5.1.1 koos standardteegi versiooniga 0.12.
Mainitud tarkvarapaketid on tasuta installeeritavad Ubuntu 16.04 LTS jt varamutest.


\clearpage

\section{Erandid}

Selles peatükis vaadeldakse keele laiendust eranditega. 
Baaskeeleks on tüübitud lambda-arvutus koos tõeväärtuste, naturaalarvude ja korrutistega.
Järgnevates alapeatükkides defineeritakse selline keel Agdas,
viiakse läbi tüübituletus koos efekti analüüsiga,
määratakse hästi tüübitud avaldiste semantika
ning tuuakse mõned optimeerivate programmiteisenduste näited.
Ühtlasi näidatakse analüüsi ja teisenduste korrektsust.

\subsection{Eranditega keel}\label{ssec:exc.raw}

Vastastikku defineeritud väärtus- ja arvutustüübid on toodud joonisel \ref{fig:exc.types}.
Lubatud väärtustüübid {\tt VType} on naturaalarvud, tõeväärtused, teiste väärtustüüpide korrutised ja tüübitud lambda-arvutused.
Arvutustüüpideks on efektiga {\tt E} annoteeritud väärtustüübid. Efekt {\tt E} on defineeritud alapeatükis \ref{ssec:exc.grading}.
\begin{figure}
  \begin{verbatim}
mutual
  data VType : Set where
    nat : VType
    bool : VType
    _∏_ : VType → VType → VType
    _⇒_ : VType → CType → VType

  data CType : Set where
    _/_ : E → VType → CType\end{verbatim}
  \caption{Eranditega keele tüübid.}
  \label{fig:exc.types}
\end{figure}


Vastastikku defineeritud väärtus- ja arvutustermid on toodud joonisel \ref{fig:exc.raw}.
% pragmatics
Termide konstruktorite nimetamisel on kasutatud suurtähti vältimaks võimalikke nimekonflikte Agda standard funktsioonidega.
Järgnevalt on selgitatud väärtustermi vTerm konstruktorite tähendust.
\begin{itemize}
  \item {\tt TT} ja {\tt FF} koostavad vastavalt tõeväärtused tõene ja väär.
  \item {\tt ZZ} koostab naturaalarvu 0 ja konstruktor {\tt SS} oma argumendist järgneva naturaalarvu.
  \item {\tt ⟨_,_⟩} koostab oma argumentide paari e. korrutise.
  \item {\tt FST} ja {\tt SND} koostavad vastavalt argumendina antud korrutise esimese ja teise projektsiooni.
  \item {\tt VAR} koostab De~Bruijn'i indeksiga määratud muutuja.
  \item {\tt LAM} on funktsiooni abstraktsioon, seejuures funktsiooni parameetri väärtustüüp on eksplitsiitselt annoteeritud. Funktsiooni kehaks on arvutusterm.
\end{itemize}

\begin{figure}
  \begin{verbatim}
mutual
  data vTerm : Set where
    TT FF : vTerm
    ZZ : vTerm
    SS : vTerm → vTerm
    ⟨_,_⟩ : vTerm → vTerm → vTerm
    FST SND : vTerm → vTerm
    VAR : ℕ → vTerm
    LAM : VType → cTerm → vTerm

  data cTerm : Set where
    VAL : vTerm → cTerm
    FAIL : VType → cTerm
    TRY_WITH_ : cTerm → cTerm → cTerm
    IF_THEN_ELSE_ : vTerm → cTerm → cTerm → cTerm
    _$_ : vTerm → vTerm → cTerm
    PREC : vTerm → cTerm → cTerm → cTerm
    LET_IN_ : cTerm → cTerm → cTerm\end{verbatim}
  \caption{Eranditega keele väärtus- ja arvutustermid.}
  \label{fig:exc.raw}
\end{figure}

Järgnevalt on selgitatud arvutustermi {\tt cTerm} konstruktorite (jn \ref{fig:exc.raw}) tähendust ja vastavas arvutuses kätketud efekti.
\begin{itemize}
  \item {\tt VAL} tähistab õnnestunud arvutust, seejuures arvutuse tulemuseks on väärtustermiga antud konstruktori argument.
  \item {\tt FAIL} tähistab arvutuse, mille väärtustüüp on eksplitsiitselt annoteeritud, ebaõnnestumist.
  \item {\tt TRY_WITH_} on erandikäsitlejaga arvutus: kogu arvutuse tulemuseks on esimese argumendiga antud termi arvutus, kui see õnnestub, vastasel korral aga teise argumendiga antud termi arvutus.
  \item {\tt IF_THEN_ELSE_} on valikuline arvutus: vastavalt väärtustermi tõeväärtusele on tulemuseks kas esimese (tõene haru) või teise (väär haru) arvutustermiga antud arvutus.
  \item {\tt _\$_} on esimese väärtustermiga antud funktsiooni rakendamine teise väärtustermiga antud väärtusele, kusjuures rakendamise efektiks on funktsioonis peituv efekt.
  \item {\tt PREC} on primitiivne rekursioon, mille sammude arv on määratud väärtustermi argumendiga. Esimene arvutusterm vastab rekursiooni baasile ja teine sammule, kusjuures sammuks on akumulaatori ja sammuloenduri parameetritega funktsioon. Kogu arvutuse efekt vastab kõigi osaarvutuste järjestikku sooritamisele.
  \item {\tt LET_IN_} lisab esimese arvutustermiga antud väärtuse teise arvutustermi kontekstis esimeseks muutujaks. Arvutuse efekt vastab osaarvutuste järjestikku sooritamisele.
\end{itemize}

\begin{figure}
  \begin{verbatim}
ADD : vTerm
ADD = LAM nat
          (VAL (LAM nat
                    (PREC (VAR 0)
                          (VAL (VAR 1))
                          (VAL (SS (VAR 0))))))

ADD-3-and-4 : cTerm
ADD-3-and-4 = LET ADD $ (SS (SS (SS ZZ)))
              IN VAR 0 $ (SS (SS (SS (SS ZZ))))

BAD-ONE : cTerm
BAD-ONE = ZZ $ TT\end{verbatim}
  \caption{Näidisavaldised eranditega keeles.}
  \label{fig:exc.raw.ex1}
\end{figure}

Joonisel \ref{fig:exc.raw.ex1} on toodud kahe naturaalarvu liitmise funktsioon väärtustermina {\tt ADD}
ning naturaalarvude 3 ja 4 liitmine arvutustermina {\tt ADD-3-and-4}.
Lisaks on toodud näide arvutustermist {\tt BAD-ONE}, mida annab konstrueerida,
kuid mis ei oma sisu: naturaalarvu null ei saa rakendada tõeväärtusele tõene.
Sellised halvasti tüübitud termid tuvastatakse tüübituletusega (alaptk \ref{ssec:exc.inference}).

\subsection{Erandite gradeering} \label{ssec:exc.grading}

Erandite efekti hinnang {\tt Exc} on toodud joonisel \ref{fig:exc.exc}:
konstruktor {\tt err} vastab arvutuse ebaõnnestumisele,
konstruktor {\tt ok} arvutuse õnnestumisele ja konstruktor {\tt errok} arvutusele,
mille kohta pole teada, kas see õnnestub või mitte.

\begin{figure}
  \begin{verbatim}
data Exc : Set where
  err : Exc
  ok : Exc
  errok : Exc

_·_ : Exc → Exc → Exc
ok · e = e
err · e = err
errok · err = err
errok · ok = errok
errok · errok = errok

_⊹_ : Exc → Exc → Exc
err ⊹ e' = e'
ok ⊹ _ = ok
errok ⊹ ok = ok
errok ⊹ _ = errok\end{verbatim}
  \caption{Erandite efektid ja operatsioonid nendel.}
  \label{fig:exc.exc}
\end{figure}

Efektide korrutamine {\tt _·_} (jn \ref{fig:exc.exc}) vastab arvutuste järjestikule sooritamisele.
Kui esimene osaarvutus õnnestub, siis kogu arvutuse efekt on määratud teise osaarvutuse efektiga.
Kui üks osaarvutustest ebaõnnestub, siis ebaõnnestub kogu arvutus.
Ülejäänud juhtudel puudub teadmine arvutuse õnnestumisest või ebaõnnestumisest.
Efektide korrutamine leiab aset {\tt LET_IN_} arvutuses (alaptk. \ref{ssec:exc.raw}).

Erandikäsitleja võib parandada kogu arvutuse hinnangut.
Põhiarvutuse ja erandikäsitleja efeki kombineerimine {\tt _⊹_} on defineeritud joonisel \ref{fig:exc.exc}.
Kui põhiarvutus ebaõnnestub, siis on kogu arvutuse efekt määratud erandikäsitleja efektiga.
Põhiarvutuse õnnestumisel on kogu arvutus õnnestunud ja erandikäsitlejat ei arvutata.
Kui põhiarvutuse õnnestumine pole teada, aga erandikäsitleja kindlasti õnnestub, siis õnnestub ka kogu arvutus.
Ülejäänud juhtudel pole teada, kas kogu arvutus tervikuna õnnestub või mitte.
Efekti hinnangu parandus leiab aset {\tt TRY_WITH_} arvutuses (alaptk. \ref{ssec:exc.raw}).

Hinnangu {\tt Exc} konstruktorid moodustavad järgneva võre:
\begin{center}
  \begin{tikzpicture}[node distance=1.5cm]
    \node (top) at (0,0) {errok};
    \node [below left  of=top] (left)  {err};
    \node [below right of=top] (right) {ok};
    \draw (top) -- (left);
    \draw (top) -- (right);
  \end{tikzpicture}
\end{center}
Hinnangute osaline järjestusseos {\tt _⊑_} on toodud joonisel \ref{fig:exc.ord}.
See seos on refleksiivne {\tt ⊑-refl}.
Transitiivsuse {\tt ⊑-trans} tõestus seisneb argumentide kuju juhtumi analüüsil.
Transitiivsuse seost on võimalik kodeerida järjestusseose konstruktorina, kuid see pole otstarbekas,
kuna hilisemates tõestuses tekib sellest täiendavad juhtumid, mida peab analüüsima.

Loomulikul viisil saab defineerida erandi hinnangu ülemise ja alumise raja ning näidata nende sümmeetrilisust.
Lihtsuse huvides on toodud ainult vastavad tüübisignatuurid ja mitte definitsioonid (jn \ref{fig:exc.ord}).
Kuna kahel hinnangul ei pruugi leiduda alumine raja, siis on {\tt _⊓_} tulemus mähitud {\tt Maybe} monaadi.
\begin{figure}
  \begin{verbatim}
data _⊑_ : Exc → Exc → Set where
  ⊑-refl : {e : Exc} → e ⊑ e
  err⊑errok : err ⊑ errok
  ok⊑errok : ok ⊑ errok
  
⊑-trans : {e e' e'' : Exc} → e ⊑ e' → e' ⊑ e'' → e ⊑ e''
⊑-trans ⊑-refl q = q
⊑-trans err⊑errok ⊑-refl = err⊑errok
⊑-trans ok⊑errok ⊑-refl = ok⊑errok

_⊔_ : Exc → Exc → Exc
_⊓_ : Exc → Exc → Maybe Exc
⊔-sym : (e e' : Exc) → e ⊔ e' ≡ e' ⊔ e
⊓-sym : (e e' : Exc) → e ⊓ e' ≡ e' ⊓ e

lub : (e e' : Exc) → e ⊑ (e ⊔ e')
glb : (e e' : Exc) {e'' : Exc} → e ⊓ e' ≡ just e'' → e'' ⊑ e
lub-sym : (e e' : Exc) → e ⊑ (e' ⊔ e)
  \end{verbatim}
  \caption{Erandite efektide järjestatus.}
  \label{fig:exc.ord}
\end{figure}
\subsubsection{Järjestatud monoid}
Hulk {\tt E}, millel on defineeritud korrutamine {\tt _·_} ja ühikelement {\tt i},
st {\tt i} on ühik korrutamise suhtes nii vasakult {\tt lu} kui ka paremalt {\tt ru},
ning korrutamine on assotsiatiivne {\tt ass}, nimetatakse monoidiks.
Kui sellel hulgal on osaline järjestatus {\tt _⊑_},
mis on refleksiivne {\tt ⊑-refl} ja transitiivne {\tt ⊑-trans},
ning kehtib korrutamise monotoonsus {\tt mon},
siis on tegemist järjestatud monoidiga.
Joonisel \ref{fig:exc.ord} on toodud järjestatud monoidi kirje tüüp Agdas.

Saab näidata, et erandite hinnag {\tt Exc},
korrutamine {\tt _·_}, mille ühikuks on konstruktor {\tt ok},
ja osaline järjestatus {\tt _⊑_} moodustavad erandite järjestatud monoidi.

\begin{figure}
  \begin{verbatim}
record OrderedMonoid : Set where
  field
    E : Set
    _·_ : E → E → E    
    i : E

    lu : {e : E } → i · e ≡ e
    ru : {e : E } → e ≡ e · i 
    ass : {e e' e'' : E} → (e · e') · e'' ≡ e · (e' · e'')
    
    _⊑_ : E → E → Set    
    ⊑-refl : {e : E} → e ⊑ e
    ⊑-trans : {e e' e'' : E} → e ⊑ e' → e' ⊑ e'' → e ⊑ e''

    mon : {e e' e'' e''' : E} → e ⊑ e'' → e' ⊑ e''' → e · e' ⊑ e'' · e'''\end{verbatim}
  \caption{Järjestatud monoid.}
  \label{fig:exc.ord}
\end{figure}

\subsubsection{Gradeeritud monaad}


\subsubsection{Alamtüübid}
Väärtus- ja arvutustüüpide osaline järjestatus on vastastikku defineeritud (jn \ref{fig:exc.subtypes}).
Konstruktoriga {\tt st-bn} loetakse tõeväärtused naturaalarvude alamtüübiks.
Kehtib väärtustüüpide refleksiivsus {\tt st-refl}.
Kaks väärtustüüpide paari on alamtüübid {\tt st-prod}, kui paaride vastavad projektsioonid on omakorda alamtüübid.
Funktsioonid on alamtüübid {\tt st-func}, kui funktsioonide kehade arvutused on alamtüübid,
ja funktsioonide argumendid on kontravariantsed.
\begin{figure}
  \begin{verbatim}
mutual
  data _≤V_ : VType → VType → Set where
    st-bn : bool ≤V nat
    st-refl : {σ : VType} → σ ≤V σ
    st-prod : {σ σ' τ τ' : VType} →
              σ ≤V σ' → τ ≤V τ' → σ ∏ τ ≤V σ' ∏ τ'
    st-func : {σ σ' : VType} {τ τ' : CType} →
              σ' ≤V σ → τ ≤C τ' → σ ⇒ τ ≤V σ' ⇒ τ'

  data _≤C_ : CType → CType → Set where
    st-comp : {e e' : E} {σ σ' : VType} →
              e ⊑ e' → σ ≤V σ' → e / σ ≤C e' / σ'


mutual
  st-trans : {σ σ' σ'' : VType} → σ ≤V σ' → σ' ≤V σ'' → σ ≤V σ''
  st-trans st-refl q = q
  st-trans p st-refl = p
  st-trans (st-prod p p') (st-prod q q') = st-prod (st-trans p q)
                                                   (st-trans p' q')
  st-trans (st-func p p') (st-func q q') = st-func (st-trans q p)
                                                   (sct-trans p' q')

  sct-trans : {σ σ' σ'' : CType} → σ ≤C σ' → σ' ≤C σ'' → σ ≤C σ''
  sct-trans (st-comp p q) (st-comp p' q') = st-comp (⊑-trans p p')
                                                    (st-trans q q')\end{verbatim}
  \caption{Väärtus- ja arvutustüüpide alamtüüpimine.}
  \label{fig:exc.subtypes}
\end{figure}
  
\subsection{Tüübituletus ja efekti analüüs} \label{ssec:exc.inference}

Joonisel \ref{fig:exc.refined} on toodud vastastikku defineeritud rafineeritud väärtus- ja arvutustermid.
Termid on parametriseeritud kontekstiga {\tt Γ} ning indekseeritud vastavalt väärtus- ja arvutustüüpidega.
Kontekst {\tt Ctx} on defineeritud kui väärtusttüüpide list.
Muutujad viitavad De~Bruijn'i indeksiga selle listi elemendile.

\begin{figure}
  \begin{verbatim}
Ctx = List VType

mutual
 data VTerm (Γ : Ctx) : VType → Set where
   TT FF : VTerm Γ bool
   ZZ : VTerm Γ nat
   SS : VTerm Γ nat → VTerm Γ nat
   ⟨_,_⟩ : {σ σ' : VType} →
           VTerm Γ σ → VTerm Γ σ' → VTerm Γ (σ ∏ σ')
   FST : {σ σ' : VType} → VTerm Γ (σ ∏ σ') → VTerm Γ σ
   SND : {σ σ' : VType} → VTerm Γ (σ ∏ σ') → VTerm Γ σ'
   VAR : {σ : VType} → σ ∈ Γ → VTerm Γ σ
   LAM : (σ : VType) {τ : CType} →
         CTerm (σ ∷ Γ) τ → VTerm Γ (σ ⇒ τ)
   VCAST : {σ σ' : VType} → VTerm Γ σ → σ ≤V σ' → VTerm Γ σ'

 data CTerm (Γ : Ctx) : CType → Set where
   VAL : {σ : VType} → VTerm Γ σ → CTerm Γ (ok / σ)
   FAIL : (σ : VType) → CTerm Γ (err / σ)
   TRY_WITH_ : {e e' : E} {σ : VType} → CTerm Γ (e / σ) →
               CTerm Γ (e' / σ) → CTerm Γ (e ⊹ e' / σ)
   IF_THEN_ELSE_ : {e e' : E} {σ : VType} → VTerm Γ bool →
     CTerm Γ (e / σ) → CTerm Γ (e' / σ) → CTerm Γ (e ⊔ e' / σ)
   _$_ : {σ : VType} {τ : CType} →
         VTerm Γ (σ ⇒ τ) → VTerm Γ σ → CTerm Γ τ
   PREC : {e e' : E} {σ : VType} → VTerm Γ nat →
          CTerm Γ (e / σ) → CTerm (σ ∷ nat ∷ Γ) (e' / σ) →
          e · e' ⊑ e → CTerm Γ (e / σ)
   LET_IN_ : {e e' : E} {σ σ' : VType} → CTerm Γ (e / σ) →
            CTerm (σ ∷ Γ) (e' / σ') → CTerm Γ (e · e' / σ')
   CCAST : {e e' : E} {σ σ' : VType} → CTerm Γ (e / σ) →
           e / σ ≤C e' / σ' → CTerm Γ (e' / σ')
  \end{verbatim}
  \caption{Eranditega keele rafineeritud termid.}
  \label{fig:exc.refined}
\end{figure}




\begin{figure}
  \begin{verbatim}
infer-vtype : (Γ : Ctx) → vTerm → Maybe VType
infer-vtype Γ TT = just bool
infer-vtype Γ FF = just bool
infer-vtype Γ ZZ = just nat
infer-vtype Γ (SS t) with  infer-vtype Γ t
... | just nat = just nat
... | _        = nothing
infer-vtype Γ ⟨ t , t' ⟩ with infer-vtype Γ t | infer-vtype Γ t'
... | just σ | just σ' = just (σ ∏ σ')
... | _      | _       = nothing
infer-vtype Γ (FST t) with infer-vtype Γ t
... | just (σ ∏ _) = just σ
... | _            = nothing
infer-vtype Γ (SND t) with infer-vtype Γ t
... | just (_ ∏ σ') = just σ'
... | _             = nothing
infer-vtype Γ (VAR x) with x <? Γ
infer-vtype Γ (VAR x) | yes p = just (lkp Γ (fromℕ≤ p))
infer-vtype Γ (VAR x) | no ¬p = nothing
infer-vtype Γ (LAM σ t) with infer-ctype (σ ∷ Γ) t
... | just τ = just (σ ⇒ τ)
... | _      = nothing\end{verbatim}
  \caption{Eranditega keele väärtustüüpide tüübituletus.}
  \label{fig:exc.infer-vtype}
\end{figure}

\begin{figure}
  \begin{verbatim}
infer-ctype : (Γ : Ctx) → cTerm → Maybe CType
infer-ctype Γ (VAL x) with infer-vtype Γ x
... | just σ = just (ok / σ)
... | _      = nothing
infer-ctype Γ (FAIL σ) = just (err / σ)
infer-ctype Γ (TRY t WITH t') with infer-ctype Γ t | infer-ctype Γ t'
... | just τ | just τ' = τ ⊹C τ'
... | _      | _       = nothing
infer-ctype Γ (IF x THEN t ELSE t')
    with infer-vtype Γ x | infer-ctype Γ t | infer-ctype Γ t'
... | just bool | just τ | just τ' = τ ⊔C τ'
... | _         | _      | _       = nothing
infer-ctype Γ (f $ t) with infer-vtype Γ f | infer-vtype Γ t
... | just (σ ⇒ τ) | just σ' with σ' ≤V? σ
...                           | yes _ = just τ
...                           | no  _ = nothing
infer-ctype Γ (f $ t) | _ | _ = nothing
infer-ctype Γ (PREC x t t')
    with infer-vtype Γ x
... | just nat with infer-ctype Γ t
...            | just (e / σ) with infer-ctype (σ ∷ nat ∷ Γ) t'
...                           | just (e' / σ') with e · e' ⊑? e | σ ≡V? σ'
...                                            | yes _ | yes _ = just (e / σ)
...                                            | _     | _     = nothing
infer-ctype Γ (PREC x t t') | just nat | just (_ / _) | _ = nothing
infer-ctype Γ (PREC x t t') | just nat | _ = nothing
infer-ctype Γ (PREC x t t') | _ = nothing
infer-ctype Γ (LET t IN t') with infer-ctype Γ t 
... | just (e / σ) with infer-ctype (σ ∷ Γ) t'
...                | just (e' / σ') = just (e · e' / σ')
...                | _              = nothing
infer-ctype Γ (LET t IN t') | _            = nothing\end{verbatim}
  \caption{Eranditega keele arvutustüüpide tüübituletus.}
  \label{fig:exc.infer-ctype}
\end{figure}


\subsection{Semantika}
aoeu
\subsection{Optimisatsioonid}
aeoust haoseu th

\clearpage

\section{Mitte-deterministlik keel}
aseo huasousato usaoheu s
This is obvious \cite{Benton2016}. \cite{Katsumata2014}

\clearpage

\section{Võimalikud edasiarendused}

- muteeritava oleku laiendused\\
- mittedeterminismi teine gradeering nd0, 1, 01, 1+, N ja selle optimisatsioonid (pure-lambda-hoist, dead-computation)

\clearpage

\section{Kokkuvõte}
Kokkuvõttes esitab autor töö põhieesmärgi, vastused sissejuhatuses püstitatud
küsimustele, toob välja töö olulisemad tulemused ja järeldused.

\clearpage

\renewcommand{\baselinestretch}{1.15}
\small
%\printbibliography[title={\vskip 60pt\centering Kasutatud kirjandus}]

\bibliographystyle{unsrt}
\bibliography{thesis}
\end{document}
